<!DOCTYPE html>
<html>
<head>
  <title>Drive-In Edge</title>
  <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
  <script src="mammoth.browser.js"></script>
  <script type="text/javascript">
    var CLIENT_ID = '72848749493-pva84reb1v48u6ddc6l7cukmsso7qib2.apps.googleusercontent.com',
        SCOPES = [
          'https://www.googleapis.com/auth/drive.metadata.readonly',
          'https://www.googleapis.com/auth/drive'
        ],
        FOLDER_ID = '0BzN4DMSEkyAFUENlamlIUVhDalU',
        TYPE_FOLDER = 'application/vnd.google-apps.folder',
        TYPE_DOCX = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';

    function checkAuth() {
      gapi.auth.authorize({
        'client_id': CLIENT_ID,
        'scope': SCOPES.join(' '),
        'immediate': true,
      }, handleAuthResult);
    }

    function handleAuthResult(result) {
      var authDiv = document.getElementById('authorize-div');
      if (result && !result.error) {
        authDiv.style.display = 'none';
        loadDriveApi();
      } else {
        authDiv.style.display = 'inline';
      }
    }

    function handleAuthClick(e) {
      gapi.auth.authorize({
        client_id: CLIENT_ID,
        scope: SCOPES,
        immediate: false
      }, handleAuthResult);
      return false;
    }

    function loadDriveApi() {
      gapi.client.load('drive', 'v2', init);
    }

    function retrieveAllFilesInFolder(folderId, callback) {
      var retrievePageOfChildren = function(request, result) {
        request.execute(function(resp) {
          result = result.concat(resp.items);
          var nextPageToken = resp.nextPageToken;
          if (nextPageToken) {
            request = gapi.client.drive.children.list({
              'folderId' : folderId,
              'pageToken': nextPageToken
            });
            retrievePageOfChildren(request, result);
          } else {
            callback(result);
          }
        });
      }
      var initialRequest = gapi.client.drive.children.list({
        'folderId' : folderId
      });
      retrievePageOfChildren(initialRequest, []);
    }


    function downloadFile(file, callback) {
      if (file.selfLink) {
        var accessToken = gapi.auth.getToken().access_token;
        var xhr = new XMLHttpRequest();
        xhr.responseType = 'blob';
        xhr.open('GET', file.selfLink + '?alt=media');
        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        xhr.onload = function() {
          var blob = xhr.response;
          console.log(blob);
          callback(blob);
        };
        xhr.onerror = function() {
          callback(null);
        };
        xhr.send();
      } else {
        callback(null);
      }
    }

    function readFileAsArrayBuffer(blob, callback) {
      var reader = new FileReader();
      reader.onload = function (e) {
        var arrayBuffer = e.target.result;
        callback(arrayBuffer);
      };
      reader.readAsArrayBuffer(blob);
    }

    function init() {
      var rootFolder = [];

      function browseFolder(id, o) {
        var req = gapi.client.drive.files.get({
          fileId: id
        });

        req.execute(function (file) {
          console.log(file);
          console.log('Title: ' + file.title);
          console.log('MIME Type: ' + file.mimeType);

          if (file.mimeType === TYPE_DOCX) {
            getContent(o, file);
          } else if (file.mimeType === TYPE_FOLDER) {
            retrieveAllFilesInFolder(file.id, processFile);
          }
        });
      }

      function getContent(o, f) {
        downloadFile(f, function (blob) {
          readFileAsArrayBuffer(blob, function (arrayBuffer) {
            mammoth
              .convertToHtml({ arrayBuffer: arrayBuffer })
              .then(function (data) {
                o.html = data.value;
                rootFolder.push(o);
                console.log(rootFolder)
              })
              .done();
          })
        });
      }

      function processFile(f) {
        var o = {};
        _.each(f, function (child) {
          browseFolder(child.id, o);
        });
      }

      retrieveAllFilesInFolder(FOLDER_ID, processFile);
    }
  </script>
</head>
<body>
  <div id="authorize-div">
    <span>Authorize access to Drive API</span>
    <button id="authorize-button" onclick="handleAuthClick(event)">
      Authorize
    </button>
  </div>
</body>
</html>
